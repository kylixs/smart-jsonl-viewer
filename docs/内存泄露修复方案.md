# å†…å­˜æ³„éœ²ä¿®å¤æ–¹æ¡ˆ

## ğŸ”´ ä¸¥é‡å†…å­˜æ³„éœ²é—®é¢˜æ±‡æ€»

### é—®é¢˜ 1: StringDecoder.vue:180 - Markdown/ä»£ç æ¸²æŸ“æœªæ¸…ç†
**å†…å­˜å ç”¨**: 64.2 MB å•æ¬¡ï¼Œç´¯è®¡ 187 MB (33.82%)

**åŸå› **:
1. `markdownHtml` ref åŒ…å«å¤§é‡æ¸²æŸ“åçš„ HTMLï¼ˆç‰¹åˆ«æ˜¯ Mermaid å›¾è¡¨ï¼‰
2. `highlightedCode` ref åŒ…å«è¯­æ³•é«˜äº®åçš„å¤§é‡ HTML
3. å¼¹çª—å…³é—­æ—¶è™½ç„¶æ¸…ç©ºäº†å­—ç¬¦ä¸²ï¼Œä½† Vue çš„è™šæ‹Ÿ DOM å’Œ Mermaid å®ä¾‹æœªå½»åº•æ¸…ç†
4. Mermaid å®ä¾‹ `mermaidInstance` æ°¸ä¹…å­˜åœ¨ï¼ŒæŒæœ‰å¤§é‡å†…éƒ¨çŠ¶æ€

**ä½ç½®**: `src/viewer/components/StringDecoder.vue:180`
```vue
<div class="markdown-preview" v-html="markdownHtml"></div>
```

### é—®é¢˜ 2: codeThemes.ts:174 - ä»£ç é«˜äº®ç»„ä»¶è¿‡æ—©åˆå§‹åŒ–
**å†…å­˜å ç”¨**: 4.6 MB å•æ¬¡ï¼Œç´¯è®¡ 21.9 MB (3.97%)

**åŸå› **:
1. Shiki é«˜äº®å™¨åœ¨ç»„ä»¶åˆ›å»ºæ—¶å°±å¯èƒ½è¢«åˆå§‹åŒ–
2. æ‰€æœ‰ä¸»é¢˜å’Œè¯­è¨€è¢«é¢„åŠ è½½ï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰æ‰“å¼€è§£ç å¼¹çª—
3. åº”è¯¥å»¶è¿Ÿåˆ°çœŸæ­£éœ€è¦æ—¶æ‰åˆå§‹åŒ–

### é—®é¢˜ 3: æœç´¢åŠŸèƒ½ - å¤šæ¬¡ä¿®æ”¹å…³é”®å­—å¯¼è‡´å†…å­˜å¿«é€Ÿå¢é•¿
**å†…å­˜å ç”¨**: è¶…è¿‡ 2GB

**åŸå› **:
1. æ¯æ¬¡æœç´¢åˆ›å»ºæ–°çš„è¿‡æ»¤ç»“æœï¼Œæ—§ç»“æœæœªé‡Šæ”¾
2. æœç´¢é«˜äº®çš„ DOM èŠ‚ç‚¹ç´¯ç§¯
3. Vue å“åº”å¼å¯¹è±¡æœªè¢«è§£å¼•ç”¨
4. å¤§æ–‡ä»¶çš„æœç´¢ç»“æœé›†å¯èƒ½éå¸¸å¤§

### é—®é¢˜ 4: vruntime-core - Vue è¿è¡Œæ—¶å ç”¨è¿‡é«˜
**å†…å­˜å ç”¨**: 99.8 MB (18.09%)

**åŸå› **:
1. Vue å“åº”å¼ç³»ç»ŸæŒæœ‰å¤§é‡æ•°æ®çš„å¼•ç”¨
2. computed å±æ€§çš„ç¼“å­˜æœªè¢«æ¸…ç†
3. watch ç›‘å¬å™¨ç´¯ç§¯

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: StringDecoder ç»„ä»¶å½»åº•æ¸…ç†

#### 1.1 æ·»åŠ èµ„æºæ¸…ç†å‡½æ•°

```typescript
// æ¸…ç†æ‰€æœ‰æ¸²æŸ“èµ„æºï¼Œé‡Šæ”¾å†…å­˜
function cleanupResources() {
  // æ¸…ç† Markdown HTMLï¼ˆåŒ…å«å¤§é‡ DOM ç»“æ„ï¼‰
  if (markdownHtml.value) {
    markdownHtml.value = ''
  }
  markdownToc.value = []

  // æ¸…ç†ä»£ç é«˜äº® HTML
  if (highlightedCode.value) {
    highlightedCode.value = ''
  }

  // æ¸…ç† Mermaid æ¸²æŸ“çš„ DOM èŠ‚ç‚¹
  if (mermaidInstance) {
    try {
      // ç§»é™¤æ‰€æœ‰ Mermaid æ¸²æŸ“çš„å…ƒç´ 
      const container = document.querySelector('.markdown-preview')
      if (container) {
        const mermaidElements = container.querySelectorAll('.mermaid[data-processed="true"]')
        mermaidElements.forEach(el => {
          el.innerHTML = '' // æ¸…ç©ºå†…éƒ¨ SVG
          el.removeAttribute('data-processed')
        })
      }
    } catch (err) {
      console.warn('Failed to cleanup Mermaid elements:', err)
    }
  }

  // å¼ºåˆ¶è§¦å‘åƒåœ¾å›æ”¶æç¤ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  if (import.meta.env.DEV) {
    console.log('[Memory] Resources cleaned up')
  }
}
```

#### 1.2 ä¿®æ”¹å¼¹çª—å…³é—­é€»è¾‘

```typescript
watch(showModal, (newValue) => {
  if (newValue) {
    // ... æ‰“å¼€é€»è¾‘ä¿æŒä¸å˜
  } else {
    // æ¢å¤é¡µé¢æ»šåŠ¨
    document.body.style.overflow = ''

    // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿å…³é—­åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      cleanupResources()
    }, 300)
  }
})
```

#### 1.3 ç»„ä»¶å¸è½½æ—¶å½»åº•æ¸…ç†

```typescript
onUnmounted(() => {
  // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
  document.removeEventListener('keydown', handleKeyDown)

  // å¦‚æœç»„ä»¶å¸è½½æ—¶å¼¹çª—è¿˜å¼€ç€ï¼Œæ¢å¤é¡µé¢æ»šåŠ¨
  if (showModal.value) {
    document.body.style.overflow = ''
  }

  // å½»åº•æ¸…ç†æ‰€æœ‰èµ„æº
  cleanupResources()

  // æ¸…ç† Mermaid å®ä¾‹
  mermaidInstance = null

  // æ¸…ç†æ‰€æœ‰ ref
  markdownHtml.value = ''
  markdownToc.value = []
  highlightedCode.value = ''
})
```

### ä¿®å¤ 2: å»¶è¿Ÿåˆå§‹åŒ– Shiki

#### 2.1 ç§»é™¤è‡ªåŠ¨åˆå§‹åŒ–

```typescript
// âŒ åˆ é™¤ï¼šåˆå§‹åŒ–è®¾ç½® Shiki ä¸»é¢˜ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œä¸é˜»å¡é¡µé¢æ¸²æŸ“ï¼‰
// const initTheme = async () => {
//   if (shikiInitialized.value) return
//   const theme = getCodeThemeById(selectedCodeTheme.value)
//   await setTheme(theme.lightTheme, theme.darkTheme, theme.mode || 'auto')
//   shikiInitialized.value = true
// }

// âœ… æ”¹ä¸ºï¼šåªåœ¨çœŸæ­£éœ€è¦æ—¶åˆå§‹åŒ–
async function initThemeOnDemand() {
  if (shikiInitialized.value) return

  // åªæœ‰åœ¨å¼¹çª—æ‰“å¼€ä¸”æ˜¯ä»£ç å†…å®¹æ—¶æ‰åˆå§‹åŒ–
  if (!showModal.value || !isCodeContent.value) {
    return
  }

  const theme = getCodeThemeById(selectedCodeTheme.value)
  await setTheme(theme.lightTheme, theme.darkTheme, theme.mode || 'auto')
  shikiInitialized.value = true
}
```

#### 2.2 ä¿®æ”¹ä»£ç é«˜äº®è§¦å‘é€»è¾‘

```typescript
// å¼‚æ­¥æ›´æ–°ä»£ç é«˜äº®ï¼ˆä»…åœ¨å¼¹çª—æ‰“å¼€æ—¶è°ƒç”¨ï¼‰
async function updateHighlightedCode() {
  // å¦‚æœä¸æ˜¯ä»£ç å†…å®¹æˆ–å¼¹çª—æœªæ‰“å¼€ï¼Œä¸æ‰§è¡Œ
  if (!isCodeContent.value || !showModal.value) {
    highlightedCode.value = ''
    return
  }

  // ç¡®ä¿ Shiki å·²åˆå§‹åŒ–
  if (!shikiInitialized.value) {
    await initThemeOnDemand()
  }

  try {
    const html = await highlightCode(decodedValue.value, selectedLanguage.value, store.isDark)
    highlightedCode.value = html
  } catch (err) {
    console.error('Failed to highlight code:', err)
    highlightedCode.value = `<pre><code>${escapeHtml(decodedValue.value)}</code></pre>`
  }
}
```

### ä¿®å¤ 3: æœç´¢åŠŸèƒ½ä¼˜åŒ–

#### 3.1 é™åˆ¶æœç´¢ç»“æœæ•°é‡

åœ¨ `jsonlStore.ts` ä¸­æ·»åŠ ï¼š

```typescript
const MAX_SEARCH_RESULTS = 10000 // æœ€å¤šä¿ç•™ 10000 æ¡æœç´¢ç»“æœ

function performSearch(query: string) {
  const results = []

  for (const item of allData) {
    if (results.length >= MAX_SEARCH_RESULTS) {
      console.warn(`Search results truncated at ${MAX_SEARCH_RESULTS} items`)
      break
    }

    if (matchesQuery(item, query)) {
      results.push(item)
    }
  }

  // é‡Šæ”¾æ—§çš„æœç´¢ç»“æœ
  searchResults.value = null
  searchResults.value = results

  return results
}
```

#### 3.2 æ¸…ç†æ—§æœç´¢ç»“æœ

```typescript
// æ‰§è¡Œæ–°æœç´¢å‰ï¼Œæ¸…ç†æ—§ç»“æœ
function clearSearchResults() {
  if (searchResults.value) {
    searchResults.value.length = 0
    searchResults.value = null
  }

  // æ¸…ç†æœç´¢é«˜äº®
  const highlights = document.querySelectorAll('.search-highlight')
  highlights.forEach(el => {
    el.classList.remove('search-highlight')
  })
}

// åœ¨æ–°æœç´¢å‰è°ƒç”¨
watch(searchQuery, () => {
  clearSearchResults()
  performSearch(searchQuery.value)
})
```

#### 3.3 ä½¿ç”¨ toRaw é¿å…å“åº”å¼å¼€é”€

```typescript
import { toRaw } from 'vue'

function processLargeData(data: any[]) {
  // å¯¹äºåªè¯»çš„å¤§æ•°æ®ï¼Œä½¿ç”¨ toRaw ç§»é™¤å“åº”å¼
  const rawData = toRaw(data)

  // å¤„ç† rawData...
}
```

### ä¿®å¤ 4: Vue å“åº”å¼ä¼˜åŒ–

#### 4.1 ä½¿ç”¨ shallowRef æ›¿ä»£ refï¼ˆå¤§å¯¹è±¡ï¼‰

```typescript
// âŒ æ—§ä»£ç 
const largeData = ref<LargeType[]>([])

// âœ… æ–°ä»£ç ï¼šå¤§æ•°ç»„ä½¿ç”¨ shallowRef
const largeData = shallowRef<LargeType[]>([])
```

#### 4.2 æ¸…ç†ä¸éœ€è¦çš„ computed ç¼“å­˜

```typescript
// æ·»åŠ æ¸…ç†å‡½æ•°
function clearComputedCache() {
  // Vue 3 ä¼šè‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„ computed
  // ä½†å¯¹äºå¤§æ•°æ®ï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘
  if (showModal.value === false) {
    // æ¸…ç†ä¸´æ—¶è®¡ç®—ç»“æœ
    tempResults.value = null
  }
}
```

#### 4.3 åœæ­¢ä¸éœ€è¦çš„ watch

```typescript
// ä½¿ç”¨ watchEffect çš„è¿”å›å€¼åœæ­¢ç›‘å¬
const stopWatch = watch(someValue, () => {
  // ...
})

// åœ¨ä¸éœ€è¦æ—¶åœæ­¢
onUnmounted(() => {
  stopWatch()
})
```

## ğŸ“ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥ä¿®å¤ï¼ˆç«‹å³ï¼‰
1. âœ… ä¿®å¤ StringDecoder çš„èµ„æºæ¸…ç†é€»è¾‘
2. âœ… å»¶è¿Ÿ Shiki åˆå§‹åŒ–
3. âœ… æ·»åŠ æœç´¢ç»“æœæ•°é‡é™åˆ¶

### ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆæœ¬å‘¨ï¼‰
1. â³ ä¼˜åŒ–æœç´¢ç»“æœæ¸…ç†
2. â³ ä½¿ç”¨ shallowRef ä¼˜åŒ–å¤§æ•°æ®
3. â³ æ·»åŠ å†…å­˜ç›‘æ§å’Œè­¦å‘Š

### ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„æ”¹è¿›ï¼ˆä¸‹å‘¨ï¼‰
1. â³ å®ç°è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ–‡ä»¶ï¼‰
2. â³ å®ç°åˆ†é¡µåŠ è½½
3. â³ è€ƒè™‘ä½¿ç”¨ Web Workers å¤„ç†å¤§æ•°æ®

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: StringDecoder ç»„ä»¶
1. æ‰“å¼€/å…³é—­è§£ç å¼¹çª— 20 æ¬¡
2. æ¯æ¬¡æ‰“å¼€ä¸åŒç±»å‹çš„å†…å®¹ï¼ˆJSONã€Markdownã€ä»£ç ï¼‰
3. ä½¿ç”¨ Chrome DevTools Memory é¢æ¿è®°å½•å †å¿«ç…§
4. éªŒè¯å†…å­˜æ˜¯å¦å›åˆ°åŸºçº¿

### æµ‹è¯•åœºæ™¯ 2: æœç´¢åŠŸèƒ½
1. åŠ è½½ 100MB çš„ JSONL æ–‡ä»¶
2. æ‰§è¡Œ 10 æ¬¡ä¸åŒçš„æœç´¢
3. æ¯æ¬¡æœç´¢åè®°å½•å†…å­˜å ç”¨
4. éªŒè¯å†…å­˜å¢é•¿æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆ< 500MBï¼‰

### æµ‹è¯•åœºæ™¯ 3: å¤§æ–‡ä»¶æ»šåŠ¨
1. åŠ è½½ 200MB çš„ JSONL æ–‡ä»¶
2. å¿«é€Ÿæ»šåŠ¨åˆ°åº•éƒ¨
3. è¿”å›é¡¶éƒ¨
4. éªŒè¯ DOM èŠ‚ç‚¹æ•°é‡æ˜¯å¦ç¨³å®š

## ğŸ“Š é¢„æœŸæ•ˆæœ

- StringDecoder å†…å­˜å ç”¨ï¼š187 MB â†’ < 20 MB
- Shiki åˆå§‹åŒ–å†…å­˜ï¼š21.9 MB â†’ æŒ‰éœ€åŠ è½½ï¼ˆ0 MB åˆå§‹ï¼‰
- æœç´¢å†…å­˜å¢é•¿ï¼š< 500 MBï¼ˆ10 æ¬¡æœç´¢ï¼‰
- æ€»ä½“å†…å­˜å ç”¨ï¼š< 1GBï¼ˆ200MB æ–‡ä»¶ï¼‰

## ğŸ” ç›‘æ§æŒ‡æ ‡

```typescript
// æ·»åŠ å†…å­˜ç›‘æ§ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
if (import.meta.env.DEV && performance.memory) {
  setInterval(() => {
    const { usedJSHeapSize, totalJSHeapSize } = performance.memory
    const usedMB = (usedJSHeapSize / 1024 / 1024).toFixed(2)
    const totalMB = (totalJSHeapSize / 1024 / 1024).toFixed(2)

    console.log(`[Memory] Used: ${usedMB} MB / ${totalMB} MB`)

    if (usedJSHeapSize > totalJSHeapSize * 0.9) {
      console.warn('[Memory] Memory usage is high! Consider cleaning up resources.')
    }
  }, 5000)
}
```
