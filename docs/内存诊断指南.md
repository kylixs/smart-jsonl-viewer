# å†…å­˜è¯Šæ–­æŒ‡å—

## ğŸ¯ ç›®çš„

æœ¬æŒ‡å—å¸®åŠ©ä½ å¿«é€Ÿè¯Šæ–­å’Œå®šä½ JSONL Viewer çš„å†…å­˜é—®é¢˜ã€‚

## ğŸ”§ å·²å®æ–½çš„ä¿®å¤

### âœ… å·²å®Œæˆä¿®å¤

1. **StringDecoder èµ„æºæ¸…ç†** (`src/viewer/components/StringDecoder.vue`)
   - æ·»åŠ  `cleanupResources()` å‡½æ•°
   - å¼¹çª—å…³é—­æ—¶æ¸…ç† Markdown HTML å’Œ Mermaid å®ä¾‹
   - ç»„ä»¶å¸è½½æ—¶å½»åº•æ¸…ç†æ‰€æœ‰èµ„æº

2. **Shiki å»¶è¿Ÿåˆå§‹åŒ–** (`src/viewer/components/StringDecoder.vue`)
   - åªåœ¨å¼¹çª—æ‰“å¼€ä¸”å†…å®¹æ˜¯ä»£ç æ—¶æ‰åˆå§‹åŒ– Shiki
   - é¿å…ä¸å¿…è¦çš„é«˜äº®å™¨åŠ è½½

3. **visibleCount è‡ªåŠ¨é‡ç½®** (`src/viewer/stores/jsonlStore.ts`)
   - æ¯æ¬¡è¿‡æ»¤åè‡ªåŠ¨é‡ç½® visibleCount
   - â‰¤500 è¡Œï¼šæ˜¾ç¤ºå…¨éƒ¨
   - >500 è¡Œï¼šåˆå§‹æ˜¾ç¤º 500 è¡Œ

4. **å½»åº•æ¸…ç†æ•°ç»„å¼•ç”¨** (`src/viewer/stores/jsonlStore.ts`)
   - `applyFilter()`: å…ˆæ¸…ç©ºæ•°ç»„é•¿åº¦å†é‡æ–°èµ‹å€¼
   - `loadJsonLines()`: å½»åº•æ¸…ç©ºæ—§æ•°æ®
   - `cleanup()`: å½»åº•æ¸…ç©ºæ‰€æœ‰æ•°æ®æ•°ç»„

## ğŸ“Š å¦‚ä½•è¯Šæ–­å†…å­˜é—®é¢˜

### æ­¥éª¤ 1: æ‰“å¼€å†…å­˜è¯Šæ–­å·¥å…·

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ‰§è¡Œï¼š

```javascript
// å¼€å§‹ç›‘æ§å†…å­˜ï¼ˆæ¯ 10 ç§’è®°å½•ä¸€æ¬¡ï¼‰
__memoryDiagnostics.startMonitoring(10000)

// ç”Ÿæˆå½“å‰å†…å­˜æŠ¥å‘Š
__memoryDiagnostics.generateReport()
```

### æ­¥éª¤ 2: æ‰§è¡Œæµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1: å¤šæ¬¡æœç´¢æµ‹è¯•

```javascript
// è®°å½•åŸºçº¿å¿«ç…§
const baseline = __memoryDiagnostics.takeSnapshot('åŸºçº¿')

// æ‰§è¡Œ 10 æ¬¡æœç´¢ï¼ˆæ‰‹åŠ¨åœ¨ UI ä¸­ä¿®æ”¹å…³é”®å­—ï¼‰
// æ¯æ¬¡æœç´¢åè®°å½•å¿«ç…§
const after1 = __memoryDiagnostics.takeSnapshot('æœç´¢1æ¬¡')
const after2 = __memoryDiagnostics.takeSnapshot('æœç´¢2æ¬¡')
// ... é‡å¤ 10 æ¬¡

// æ¯”è¾ƒåŸºçº¿å’Œæœ€åä¸€æ¬¡æœç´¢åçš„å†…å­˜
const snapshots = __memoryDiagnostics.getSnapshots()
__memoryDiagnostics.compareSnapshots(baseline, snapshots[snapshots.length - 1])
```

#### åœºæ™¯ 2: StringDecoder æµ‹è¯•

```javascript
// è®°å½•åŸºçº¿
const baseline = __memoryDiagnostics.takeSnapshot('åŸºçº¿')

// æ‰“å¼€/å…³é—­è§£ç å¼¹çª— 20 æ¬¡ï¼ˆæ‰‹åŠ¨æ“ä½œï¼‰
// ...

// è®°å½•ç»“æœ
const after = __memoryDiagnostics.takeSnapshot('å…³é—­20æ¬¡å')
__memoryDiagnostics.compareSnapshots(baseline, after)
```

### æ­¥éª¤ 3: æ£€æŸ¥ Store æ•°æ®å¤§å°

```javascript
// åˆ†æ Store ä¸­çš„æ•°æ®å ç”¨
import { useJsonlStore } from './src/viewer/stores/jsonlStore'
const store = useJsonlStore()

__memoryDiagnostics.analyzeStoreSize(store)
```

### æ­¥éª¤ 4: æ£€æŸ¥ DOM èŠ‚ç‚¹æ•°é‡

```javascript
// æŸ¥çœ‹ DOM ç»Ÿè®¡
__memoryDiagnostics.getDOMStats()

// é¢„æœŸç»“æœï¼š
// - jsonLineItems: åº”è¯¥æ¥è¿‘ visibleCountï¼ˆ500-1000 å·¦å³ï¼‰
// - treeNodes: å–å†³äºå±•å¼€çš„èŠ‚ç‚¹
// - decoderModals: åº”è¯¥ â‰¤ 1ï¼ˆå…³é—­æ—¶åº”ä¸º 0ï¼‰
```

### æ­¥éª¤ 5: Chrome DevTools Heap Snapshot

1. æ‰“å¼€ Chrome DevTools â†’ Memory é¢æ¿
2. æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å¹¶åœ¨æ¯æ­¥åæ‹æ‘„å¿«ç…§ï¼š

   - **Snapshot 1**: åŠ è½½æ–‡ä»¶åï¼ˆåŸºçº¿ï¼‰
   - **Snapshot 2**: æ»šåŠ¨åˆ°ç¬¬ 5000 è¡Œ
   - **Snapshot 3**: æœç´¢ 10 æ¬¡
   - **Snapshot 4**: æ¸…ç©ºæœç´¢
   - **Snapshot 5**: ç‚¹å‡»åƒåœ¾å›æ”¶æŒ‰é’®

3. æ¯”è¾ƒå¿«ç…§ï¼Œæ‰¾å‡ºå†…å­˜å¢é•¿çš„å¯¹è±¡ç±»å‹

## ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: æœç´¢åå†…å­˜æŒç»­å¢é•¿

**æ£€æŸ¥é¡¹**:
```javascript
// 1. æ£€æŸ¥ visibleCount æ˜¯å¦æ­£ç¡®é‡ç½®
console.log('visibleCount:', store.visibleCount)
console.log('filteredLines.length:', store.filteredLines.length)

// é¢„æœŸï¼švisibleCount åº”è¯¥ â‰¤ 500ï¼ˆå¯¹äºå¤§ç»“æœé›†ï¼‰

// 2. æ£€æŸ¥ filteredLines æ˜¯å¦æ­£ç¡®æ›´æ–°
console.log('filteredLines æ˜¯å¦ä¸ºç©ºæ•°ç»„:', store.filteredLines.length === 0)
```

**å¯èƒ½åŸå› **:
- `visibleCount` æ²¡æœ‰é‡ç½® â†’ å·²ä¿®å¤
- `filteredLines` æ—§æ•°æ®æ²¡æœ‰é‡Šæ”¾ â†’ å·²ä¿®å¤

### é—®é¢˜ 2: StringDecoder å ç”¨å†…å­˜è¿‡é«˜

**æ£€æŸ¥é¡¹**:
```javascript
// 1. æ£€æŸ¥æ˜¯å¦æœ‰æœªå…³é—­çš„å¼¹çª—
__memoryDiagnostics.getDOMStats()

// é¢„æœŸï¼šdecoderModals åº”è¯¥ â‰¤ 1

// 2. æ£€æŸ¥ Mermaid å®ä¾‹
document.querySelectorAll('.mermaid[data-processed="true"]').length

// é¢„æœŸï¼šå¼¹çª—å…³é—­ååº”è¯¥ä¸º 0
```

**å¯èƒ½åŸå› **:
- Mermaid å®ä¾‹æœªæ¸…ç† â†’ å·²ä¿®å¤
- Markdown HTML æœªæ¸…ç©º â†’ å·²ä¿®å¤

### é—®é¢˜ 3: allLines æ•°æ®æœ¬èº«å ç”¨è¿‡é«˜

**æ£€æŸ¥é¡¹**:
```javascript
// ä¼°ç®— allLines æ•°æ®å¤§å°
const allLinesSize = __memoryDiagnostics.estimateDataSize(store.allLines)
console.log(`allLines å¤§å°: ${(allLinesSize / 1024 / 1024).toFixed(2)} MB`)

// å¦‚æœ allLines æœ¬èº«å°±å¾ˆå¤§ï¼ˆå¦‚ > 500 MBï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„
```

**å¯èƒ½çš„ä¼˜åŒ–**:
- ä½¿ç”¨ `shallowRef` æ›¿ä»£ `ref`ï¼ˆå‡å°‘å“åº”å¼å¼€é”€ï¼‰
- ä½¿ç”¨ `markRaw()` åŒ…è£…å¤§æ•°æ®å¯¹è±¡

### é—®é¢˜ 4: Vue å“åº”å¼ç³»ç»Ÿå ç”¨é«˜

**æ£€æŸ¥é¡¹**:
```javascript
// 1. æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡ watch
// 2. æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯å¼•ç”¨
// 3. æ£€æŸ¥æ˜¯å¦æœ‰æœªé‡Šæ”¾çš„ computed
```

**å¯èƒ½çš„ä¼˜åŒ–**:
```javascript
import { markRaw, shallowRef } from 'vue'

// æ–¹æ³• 1: ä½¿ç”¨ markRawï¼ˆé˜»æ­¢å“åº”å¼ï¼‰
const largeData = markRaw(hugeObject)

// æ–¹æ³• 2: ä½¿ç”¨ shallowRefï¼ˆæµ…å“åº”å¼ï¼‰
const largeArray = shallowRef([])
```

## ğŸ“ˆ å†…å­˜ä½¿ç”¨åŸºå‡†

### æ­£å¸¸èŒƒå›´ï¼ˆ100MB æ–‡ä»¶ï¼‰

| åœºæ™¯ | é¢„æœŸå†…å­˜å ç”¨ |
|------|-------------|
| åŠ è½½å | 200-300 MB |
| æœç´¢ 1 æ¬¡ | 250-350 MB |
| æœç´¢ 10 æ¬¡ | 300-500 MB |
| æ»šåŠ¨åˆ° 5000 è¡Œ | 300-400 MB |

### âš ï¸ å¼‚å¸¸èŒƒå›´

| åœºæ™¯ | å¼‚å¸¸æ ‡å¿— |
|------|---------|
| æœç´¢ 10 æ¬¡å | > 1 GB |
| æ‰“å¼€/å…³é—­å¼¹çª— 20 æ¬¡ | å¢é•¿ > 500 MB |
| æ»šåŠ¨åæœç´¢ | å†…å­˜ä¸ä¸‹é™ |

## ğŸ› ï¸ é«˜çº§è¯Šæ–­

### å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆChrome å¯åŠ¨å‚æ•°ï¼‰

```bash
# å¯åŠ¨ Chrome æ—¶æ·»åŠ å‚æ•°ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --js-flags="--expose-gc"
```

ç„¶ååœ¨æ§åˆ¶å°ä¸­ï¼š

```javascript
// æ‰‹åŠ¨è§¦å‘ GC
__memoryDiagnostics.suggestGC()
```

### æ€§èƒ½åˆ†æ

```javascript
// 1. å¼€å§‹æ€§èƒ½è®°å½•
performance.mark('start')

// 2. æ‰§è¡Œæ“ä½œï¼ˆå¦‚æœç´¢ï¼‰
store.setSearchKeyword('test')

// 3. ç»“æŸæ€§èƒ½è®°å½•
performance.mark('end')
performance.measure('search', 'start', 'end')
console.log(performance.getEntriesByType('measure'))
```

## ğŸ“ æŠ¥å‘Šé—®é¢˜æ¨¡æ¿

å¦‚æœå‘ç°å†…å­˜é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

```markdown
### ç¯å¢ƒ
- Chrome ç‰ˆæœ¬ï¼š
- æ–‡ä»¶å¤§å°ï¼š
- è¡Œæ•°ï¼š

### æ“ä½œæ­¥éª¤
1. åŠ è½½ XX MB æ–‡ä»¶
2. æœç´¢ XX æ¬¡
3. ...

### å†…å­˜æ•°æ®
- åŸºçº¿å†…å­˜ï¼šXX MB
- æ“ä½œåå†…å­˜ï¼šXX MB
- å¢é•¿ï¼šXX MB (+XX%)

### Heap Snapshot å¯¹æ¯”
- ä¸»è¦å¢é•¿å¯¹è±¡ï¼š
- Retainer é“¾ï¼š

### æ§åˆ¶å°æ—¥å¿—
```
