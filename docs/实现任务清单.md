# 虚拟滚动实现任务清单

## 📋 总览

本文档列出了实现虚拟滚动功能的所有任务，按模块和优先级组织。

### 进度追踪

- **总任务数**: 25
- **已完成**: 0
- **进行中**: 0
- **待开始**: 25

---

## 阶段 1: 核心基础设施（P0 - 最高优先级）

### 1.1 虚拟滚动引擎 ⏳

**文件**: `src/viewer/utils/virtualScroll.ts`

**任务**:
- [ ] 1.1.1 定义 `VirtualScrollConfig` 接口
- [ ] 1.1.2 定义 `VirtualScrollState` 接口
- [ ] 1.1.3 实现 `VirtualScrollManager` 类
  - [ ] 构造函数和初始化
  - [ ] `setTotalCount()` 方法
  - [ ] `setViewportHeight()` 方法
  - [ ] `handleScroll()` 方法
  - [ ] `updateViewport()` 方法（核心算法）
  - [ ] `getRenderRange()` 方法
  - [ ] `getContainerStyle()` 方法
  - [ ] `getContentStyle()` 方法
  - [ ] `scrollToIndex()` 方法
  - [ ] `scrollToBottom()` 方法
  - [ ] `isAtBottom()` 方法
- [ ] 1.1.4 实现 `calculateViewportHeight()` 工具函数
- [ ] 1.1.5 实现 `createDefaultConfig()` 工具函数
- [ ] 1.1.6 添加完整的 TypeScript 类型定义

**估计时间**: 4-6 小时

**依赖**: 无

**验收标准**:
- ✅ 所有接口和类型定义完整
- ✅ 视窗计算算法正确（手动计算验证）
- ✅ 支持动态调整视窗高度
- ✅ 单元测试覆盖核心方法

---

### 1.2 Vue 虚拟滚动组件 ⏳

**文件**: `src/viewer/components/VirtualScrollList.vue`

**任务**:
- [ ] 1.2.1 创建组件基础结构
  - [ ] `<template>` 结构（虚拟容器 + 内容区）
  - [ ] `<script setup>` 基础逻辑
  - [ ] `<style scoped>` 样式
- [ ] 1.2.2 集成 `VirtualScrollManager`
  - [ ] 初始化管理器
  - [ ] 监听数据变化
  - [ ] 监听窗口大小变化
- [ ] 1.2.3 实现滚动事件处理
  - [ ] `handleScroll` 方法
  - [ ] 防抖优化（requestAnimationFrame）
- [ ] 1.2.4 实现数据渲染
  - [ ] `visibleItems` computed 属性
  - [ ] `spacerStyle` computed 属性
  - [ ] `contentStyle` computed 属性
- [ ] 1.2.5 暴露公共方法
  - [ ] `scrollToIndex()`
  - [ ] `scrollToBottom()`
  - [ ] `getScrollEngine()`

**估计时间**: 3-4 小时

**依赖**: 1.1 虚拟滚动引擎

**验收标准**:
- ✅ 组件可以正常渲染
- ✅ 滚动流畅（60 FPS）
- ✅ 只渲染可见内容 + 缓冲区
- ✅ 响应式调整视窗大小

---

## 阶段 2: 数据管理（P0）

### 2.1 过滤引擎 ⏳

**文件**: `src/viewer/utils/filterEngine.ts`

**任务**:
- [ ] 2.1.1 定义 `FilterOptions` 接口
- [ ] 2.1.2 定义 `FilterResult` 接口
- [ ] 2.1.3 实现 `FilterEngine` 类
  - [ ] `applyFilter()` 方法
  - [ ] `filterLines()` 方法
  - [ ] `fuzzyMatch()` 方法
  - [ ] `exactMatch()` 方法
  - [ ] `regexMatch()` 方法
  - [ ] `jsonPathMatch()` 方法
  - [ ] `extractByPath()` 工具方法
- [ ] 2.1.4 性能优化
  - [ ] 增量过滤（大数据集）
  - [ ] Web Worker 支持（可选）

**估计时间**: 2-3 小时

**依赖**: 无

**验收标准**:
- ✅ 支持 4 种过滤模式
- ✅ 过滤速度 < 100ms（10,000 行）
- ✅ 正确处理特殊字符和边界情况

---

### 2.2 查找引擎 ⏳

**文件**: `src/viewer/utils/findEngine.ts`

**任务**:
- [ ] 2.2.1 定义 `FindOptions` 接口
- [ ] 2.2.2 定义 `FindResult` 接口
- [ ] 2.2.3 实现 `FindEngine` 类
  - [ ] `find()` 方法（生成索引数组）
  - [ ] `findNext()` 方法
  - [ ] `findPrevious()` 方法
  - [ ] `matchLine()` 方法
  - [ ] `isMatch()` 方法
  - [ ] `isCurrentMatch()` 方法
  - [ ] `getStatus()` 方法
  - [ ] `clear()` 方法
- [ ] 2.2.4 集成虚拟滚动
  - [ ] 触发滚动到匹配项
  - [ ] 高亮当前匹配

**估计时间**: 2-3 小时

**依赖**: 1.1 虚拟滚动引擎

**验收标准**:
- ✅ 查找不改变数据（只生成索引）
- ✅ 支持上/下一个匹配
- ✅ 自动滚动到匹配项并居中
- ✅ 正确显示查找结果数量

---

## 阶段 3: 用户交互（P1）

### 3.1 键盘导航 ⏳

**文件**: `src/viewer/utils/keyboardNavigator.ts`

**任务**:
- [ ] 3.1.1 定义快捷键映射
- [ ] 3.1.2 实现 `KeyboardNavigator` 类
  - [ ] `bind()` 方法（绑定事件）
  - [ ] `unbind()` 方法（解绑事件）
  - [ ] `handleKeyDown()` 方法
  - [ ] `moveLine()` 方法（上/下移动）
  - [ ] `movePage()` 方法（Page Up/Down）
  - [ ] `moveToStart()` 方法（Home）
  - [ ] `moveToEnd()` 方法（End）
  - [ ] `openFindPanel()` 方法（Ctrl+F）
  - [ ] `findNext()` 方法（F3）
  - [ ] `findPrevious()` 方法（Shift+F3）

**估计时间**: 2 小时

**依赖**: 1.1 虚拟滚动引擎, 2.2 查找引擎

**验收标准**:
- ✅ 所有快捷键正常工作
- ✅ 不与浏览器快捷键冲突
- ✅ Page Up/Down 保留 1 行重叠

---

### 3.2 查找面板组件 ⏳

**文件**: `src/viewer/components/FindPanel.vue`

**任务**:
- [ ] 3.2.1 创建 UI 组件
  - [ ] 输入框
  - [ ] 选项按钮（大小写、全字、正则）
  - [ ] 结果统计
  - [ ] 导航按钮（上/下一个）
  - [ ] 关闭按钮
- [ ] 3.2.2 实现交互逻辑
  - [ ] 实时查找（输入防抖）
  - [ ] 快捷键支持（Enter, Shift+Enter, Escape）
  - [ ] 状态更新
- [ ] 3.2.3 样式设计
  - [ ] 浮动面板
  - [ ] 暗色主题支持
  - [ ] 响应式布局

**估计时间**: 2-3 小时

**依赖**: 2.2 查找引擎

**验收标准**:
- ✅ UI 美观易用
- ✅ 实时查找流畅
- ✅ 正确显示查找状态

---

## 阶段 4: 集成和优化（P1）

### 4.1 Store 集成 ⏳

**文件**: `src/viewer/stores/jsonlStore.ts`

**任务**:
- [ ] 4.1.1 移除旧的分页逻辑
  - [ ] 删除 `visibleCount`
  - [ ] 删除 `batchSize`
  - [ ] 删除 `loadMore()`
  - [ ] 删除 `loadAll()`
  - [ ] 删除 `scheduleRender()`
  - [ ] 删除 `progressiveRender()`
- [ ] 4.1.2 添加虚拟滚动集成
  - [ ] 保持 `allLines`
  - [ ] 保持 `filteredLines`
  - [ ] 集成 `FilterEngine`
  - [ ] 集成 `FindEngine`
- [ ] 4.1.3 更新过滤逻辑
  - [ ] 使用新的 FilterEngine
  - [ ] 过滤后清空查找结果

**估计时间**: 2-3 小时

**依赖**: 2.1 过滤引擎, 2.2 查找引擎

**验收标准**:
- ✅ 旧代码完全移除
- ✅ 过滤功能正常工作
- ✅ 查找功能正常工作

---

### 4.2 主列表组件重构 ⏳

**文件**: `src/viewer/components/JsonLineList.vue`

**任务**:
- [ ] 4.2.1 替换为 VirtualScrollList
  - [ ] 移除旧的列表渲染
  - [ ] 集成 VirtualScrollList 组件
  - [ ] 传递正确的 props
- [ ] 4.2.2 添加过滤和查找 UI
  - [ ] 过滤输入框
  - [ ] 过滤模式选择
  - [ ] 查找按钮
  - [ ] FindPanel 集成
- [ ] 4.2.3 处理查找高亮
  - [ ] 添加 CSS 类名判断
  - [ ] 高亮样式
  - [ ] 当前匹配闪烁动画

**估计时间**: 3-4 小时

**依赖**: 1.2 VirtualScrollList, 3.2 FindPanel, 4.1 Store 集成

**验收标准**:
- ✅ 虚拟滚动正常工作
- ✅ 过滤和查找功能正常
- ✅ 高亮显示正确

---

### 4.3 性能优化 ⏳

**任务**:
- [ ] 4.3.1 滚动性能优化
  - [ ] requestAnimationFrame 防抖
  - [ ] transform GPU 加速
  - [ ] will-change CSS 提示
- [ ] 4.3.2 查找性能优化
  - [ ] 大数据集增量查找
  - [ ] Web Worker 异步查找（可选）
- [ ] 4.3.3 内存优化
  - [ ] 及时清理旧数据
  - [ ] 避免内存泄漏
- [ ] 4.3.4 渲染优化
  - [ ] 避免不必要的重渲染
  - [ ] computed 缓存优化

**估计时间**: 2-3 小时

**依赖**: 所有前面的任务

**验收标准**:
- ✅ 滚动帧率稳定 60 FPS
- ✅ 内存占用 < 100 MB
- ✅ 查找速度 < 1 秒（10,000 行）

---

## 阶段 5: 测试和文档（P2）

### 5.1 单元测试 ⏳

**任务**:
- [ ] 5.1.1 VirtualScrollManager 测试
  - [ ] 视窗计算测试
  - [ ] 滚动逻辑测试
  - [ ] 边界情况测试
- [ ] 5.1.2 FilterEngine 测试
  - [ ] 各种过滤模式测试
  - [ ] 边界情况测试
- [ ] 5.1.3 FindEngine 测试
  - [ ] 查找逻辑测试
  - [ ] 上/下一个测试

**估计时间**: 3-4 小时

**依赖**: 所有功能实现完成

---

### 5.2 集成测试 ⏳

**任务**:
- [ ] 5.2.1 性能测试
  - [ ] 100 MB 文件加载测试
  - [ ] 滚动性能测试
  - [ ] 内存占用测试
- [ ] 5.2.2 功能测试
  - [ ] 过滤功能测试
  - [ ] 查找功能测试
  - [ ] 键盘导航测试
- [ ] 5.2.3 边界测试
  - [ ] 空数据
  - [ ] 极大数据（1,000,000 行）
  - [ ] 快速滚动

**估计时间**: 2-3 小时

**依赖**: 5.1 单元测试

---

### 5.3 用户文档 ⏳

**任务**:
- [ ] 5.3.1 更新 README
  - [ ] 新功能说明
  - [ ] 性能提升说明
- [ ] 5.3.2 快捷键文档
  - [ ] 列出所有快捷键
  - [ ] 使用说明
- [ ] 5.3.3 故障排查文档
  - [ ] 常见问题
  - [ ] 解决方案

**估计时间**: 1-2 小时

---

## 优先级说明

- **P0 (最高)**: 核心功能，必须完成
- **P1 (高)**: 重要功能，应该完成
- **P2 (中)**: 锦上添花，时间允许时完成

## 实施顺序

```
第 1 天:
  ✅ 1.1 虚拟滚动引擎
  ✅ 1.2 Vue 虚拟滚动组件

第 2 天:
  ✅ 2.1 过滤引擎
  ✅ 2.2 查找引擎
  ✅ 3.1 键盘导航

第 3 天:
  ✅ 3.2 查找面板组件
  ✅ 4.1 Store 集成
  ✅ 4.2 主列表组件重构

第 4 天:
  ✅ 4.3 性能优化
  ✅ 5.1 单元测试
  ✅ 5.2 集成测试

第 5 天:
  ✅ 5.3 用户文档
  ✅ Bug 修复
  ✅ 发布准备
```

## 风险和缓解

### 风险 1: 性能不达标
- **缓解**: 提前做性能测试，及时优化
- **回退**: 保留旧代码，可以回退

### 风险 2: 兼容性问题
- **缓解**: 充分测试不同浏览器
- **回退**: 功能开关，逐步发布

### 风险 3: 用户体验问题
- **缓解**: 内测收集反馈
- **回退**: 提供旧版本选项

## 验收标准

### 功能完整性
- ✅ 虚拟滚动正常工作
- ✅ 过滤功能正常工作
- ✅ 查找功能正常工作
- ✅ 键盘导航正常工作

### 性能指标
- ✅ 100,000 行加载 < 1 秒
- ✅ 内存占用 < 100 MB
- ✅ DOM 节点 = 400 个
- ✅ 滚动帧率 = 60 FPS

### 用户体验
- ✅ 滚动流畅无卡顿
- ✅ 查找响应及时
- ✅ 快捷键符合习惯
- ✅ UI 美观易用
