# è™šæ‹Ÿæ»šåŠ¨è®¾è®¡æ–‡æ¡£

## ğŸ“‹ è®¾è®¡ç›®æ ‡

1. **åªæ¸²æŸ“å¯è§å†…å®¹** - å‡å°‘ DOM èŠ‚ç‚¹æ•°é‡ï¼Œæå‡æ€§èƒ½
2. **åŠ¨æ€è§†çª—** - æ ¹æ®çª—å£å¤§å°è‡ªåŠ¨è°ƒæ•´å¯è§è¡Œæ•°
3. **é¢„åŠ è½½æœºåˆ¶** - æ»šåŠ¨æ—¶æå‰åŠ è½½ç¼“å†²åŒºæ•°æ®
4. **è‡ªåŠ¨é‡Šæ”¾** - è¶…å‡ºèŒƒå›´çš„ DOM è‡ªåŠ¨é”€æ¯
5. **æ»šåŠ¨æ¡æ”¯æŒ** - æ”¯æŒæ‹–åŠ¨æ»šåŠ¨æ¡å¿«é€Ÿå®šä½
6. **Tail -f æ¨¡å¼** - è‡ªåŠ¨è¿½åŠ æ–°å†…å®¹ï¼Œå›ºå®šæœ€å¤§è¡Œæ•°

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ€»æ•°æ® (10,000 è¡Œ)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     ç¼“å†²åŒºä¸Š (5 è¡Œ)            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   å¯è§è§†çª— (20 è¡Œ)      â”‚  â”‚  â”‚ â† ç”¨æˆ·å®é™…çœ‹åˆ°çš„
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚     ç¼“å†²åŒºä¸‹ (5 è¡Œ)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  â† å®é™…æ¸²æŸ“ 30 è¡Œ DOM              â”‚
â”‚  â† è™šæ‹Ÿé«˜åº¦ 10,000 * itemHeight    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `itemHeight` | æ¯è¡Œé«˜åº¦ï¼ˆpxï¼‰ | 40 |
| `viewportHeight` | è§†çª—è¡Œæ•° | åŠ¨æ€è®¡ç®— |
| `bufferSize` | ç¼“å†²åŒºå¤§å°ï¼ˆå‰åå„ï¼‰ | 5 |
| `maxTailLines` | Tail æ¨¡å¼æœ€å¤§è¡Œæ•° | 10,000 |

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. è™šæ‹Ÿæ»šåŠ¨ç®¡ç†å™¨ (`virtualScroll.ts`)

```typescript
class VirtualScrollManager {
  // çŠ¶æ€
  state: {
    totalCount: number        // æ€»æ•°æ®è¡Œæ•°
    scrollTop: number         // æ»šåŠ¨ä½ç½®
    startIndex: number        // å¯è§èµ·å§‹ç´¢å¼•
    endIndex: number          // å¯è§ç»“æŸç´¢å¼•
    renderStartIndex: number  // æ¸²æŸ“èµ·å§‹ç´¢å¼•ï¼ˆå«ç¼“å†²ï¼‰
    renderEndIndex: number    // æ¸²æŸ“ç»“æŸç´¢å¼•ï¼ˆå«ç¼“å†²ï¼‰
    totalHeight: number       // è™šæ‹Ÿæ€»é«˜åº¦
    offsetY: number           // å†…å®¹åç§»é‡
  }

  // æ ¸å¿ƒæ–¹æ³•
  updateViewport()            // æ›´æ–°è§†çª—èŒƒå›´
  handleScroll(scrollTop)     // å¤„ç†æ»šåŠ¨
  scrollToIndex(index)        // æ»šåŠ¨åˆ°æŒ‡å®šè¡Œ
  appendData(items)           // è¿½åŠ æ•°æ®ï¼ˆTail æ¨¡å¼ï¼‰
}
```

### 2. è§†çª—è®¡ç®—ç®—æ³•

```typescript
// 1. è®¡ç®—å¯è§åŒºåŸŸ
startIndex = Math.floor(scrollTop / itemHeight)
endIndex = Math.min(startIndex + viewportHeight, totalCount)

// 2. è®¡ç®—æ¸²æŸ“åŒºåŸŸï¼ˆå«ç¼“å†²ï¼‰
renderStartIndex = Math.max(0, startIndex - bufferSize)
renderEndIndex = Math.min(totalCount, endIndex + bufferSize)

// 3. è®¡ç®—åç§»é‡ï¼ˆç”¨äºå®šä½ï¼‰
offsetY = renderStartIndex * itemHeight
```

### 3. DOM ç»“æ„

```html
<div class="scroll-container" @scroll="handleScroll">
  <!-- è™šæ‹Ÿæ’‘å¼€å®¹å™¨ï¼ˆç”¨äºæ»šåŠ¨æ¡ï¼‰ -->
  <div class="virtual-spacer" :style="{ height: totalHeight + 'px' }"></div>

  <!-- å®é™…æ¸²æŸ“çš„å†…å®¹ï¼ˆå¸¦åç§»ï¼‰ -->
  <div class="content-wrapper" :style="{ transform: `translateY(${offsetY}px)` }">
    <div v-for="item in visibleItems" :key="item.id">
      {{ item.content }}
    </div>
  </div>
</div>
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ¸²æŸ“èŠ‚ç‚¹æ•°é‡å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ»šåŠ¨ | è™šæ‹Ÿæ»šåŠ¨ | èŠ‚çœ |
|------|---------|---------|------|
| 10,000 è¡Œæ•°æ® | 10,000 ä¸ª DOM | 30 ä¸ª DOM | **99.7%** |
| 100,000 è¡Œæ•°æ® | 100,000 ä¸ª DOM | 30 ä¸ª DOM | **99.97%** |

### å†…å­˜å ç”¨å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ»šåŠ¨ | è™šæ‹Ÿæ»šåŠ¨ | èŠ‚çœ |
|------|---------|---------|------|
| 10,000 è¡Œ | ~500 MB | ~10 MB | **98%** |
| 100,000 è¡Œ | ~5 GB | ~10 MB | **99.8%** |

## ğŸ¯ Tail -f æ¨¡å¼å®ç°

### å·¥ä½œæµç¨‹

```
1. å¯ç”¨ Tail æ¨¡å¼
   â†“
2. è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
   â†“
3. æŒç»­è¿½åŠ æ–°æ•°æ®
   â†“
4. æ£€æŸ¥æ€»è¡Œæ•°æ˜¯å¦è¶…è¿‡ maxTailLines
   â†“
5. å¦‚æœè¶…è¿‡ï¼Œç§»é™¤æœ€æ—§çš„æ•°æ®ï¼ˆFIFOï¼‰
   â†“
6. ä¿æŒè§†çª—åœ¨åº•éƒ¨ï¼ˆè‡ªåŠ¨æ»šåŠ¨ï¼‰
```

### ä»£ç ç¤ºä¾‹

```typescript
// å¯ç”¨ Tail æ¨¡å¼
manager.enableTailMode()

// è¿½åŠ æ–°æ•°æ®ï¼ˆä¾‹å¦‚ï¼šæ¯ç§’è¿½åŠ  10 è¡Œï¼‰
setInterval(() => {
  const newItems = generateNewLines(10)
  manager.appendData(newItems)
}, 1000)

// å¤„ç†æº¢å‡ºï¼ˆç§»é™¤æ—§æ•°æ®ï¼‰
manager.onTailOverflow = (removeCount) => {
  // ä»æ•°æ®æºç§»é™¤å‰ removeCount è¡Œ
  dataSource.splice(0, removeCount)
}
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```vue
<template>
  <VirtualScrollList
    :items="allLines"
    :item-height="40"
    :max-tail-lines="10000"
    @load-range="handleLoadRange"
    @remove-old-data="handleRemoveOldData"
  />
</template>

<script setup>
import { ref } from 'vue'
import VirtualScrollList from './VirtualScrollList.vue'

const allLines = ref([])

// åŠ è½½æ•°æ®èŒƒå›´ï¼ˆå¯ç”¨äºæ‡’åŠ è½½ï¼‰
function handleLoadRange(start, end) {
  console.log(`éœ€è¦åŠ è½½: ${start} - ${end}`)
  // å¦‚æœæ•°æ®æœªåŠ è½½ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¯·æ±‚
}

// ç§»é™¤æ—§æ•°æ®ï¼ˆTail æ¨¡å¼æº¢å‡ºï¼‰
function handleRemoveOldData(count) {
  console.log(`ç§»é™¤å‰ ${count} è¡Œ`)
  allLines.value.splice(0, count)
}
</script>
```

### Tail -f æ¨¡å¼ç¤ºä¾‹

```vue
<template>
  <VirtualScrollList
    ref="listRef"
    :items="allLines"
    :max-tail-lines="5000"
  />
  <button @click="startTailing">å¼€å§‹ç›‘å¬</button>
</template>

<script setup>
import { ref, onUnmounted } from 'vue'

const listRef = ref()
const allLines = ref([])
let tailInterval = null

function startTailing() {
  // å¯ç”¨ Tail æ¨¡å¼
  listRef.value?.enableTailMode()

  // æ¨¡æ‹ŸæŒç»­è¿½åŠ æ•°æ®
  tailInterval = setInterval(() => {
    const newLines = [
      {
        id: `line-${Date.now()}`,
        lineNumber: allLines.value.length + 1,
        content: `æ–°æ—¥å¿— ${new Date().toISOString()}`
      }
    ]

    // è¿½åŠ åˆ°æ•°æ®æº
    allLines.value.push(...newLines)

    // é€šçŸ¥è™šæ‹Ÿæ»šåŠ¨
    listRef.value?.appendData(newLines)
  }, 1000)
}

onUnmounted(() => {
  if (tailInterval) {
    clearInterval(tailInterval)
  }
})
</script>
```

## ğŸš€ é›†æˆåˆ° JSONL Viewer

### æ”¹é€ è®¡åˆ’

1. **æ›¿æ¢ç°æœ‰åˆ—è¡¨æ¸²æŸ“**
   - å°† `JsonLineList.vue` æ”¹ä¸ºä½¿ç”¨ `VirtualScrollList`
   - ä¿æŒç°æœ‰çš„æœç´¢/è¿‡æ»¤åŠŸèƒ½

2. **æ•°æ®å±‚é€‚é…**
   ```typescript
   // jsonlStore.ts
   const allLines = ref([])           // ä¿æŒä¸å˜
   const filteredLines = ref([])      // ä¿æŒä¸å˜
   const visibleCount = ref(500)      // åˆ é™¤ï¼ˆç”±è™šæ‹Ÿæ»šåŠ¨ç®¡ç†ï¼‰
   ```

3. **ç»„ä»¶æ”¹é€ **
   ```vue
   <VirtualScrollList
     :items="store.filteredLines"
     :item-height="estimatedItemHeight"
     @load-range="handleLoadRange"
   >
     <template #item="{ item }">
       <JsonLineItem :line="item" />
     </template>
   </VirtualScrollList>
   ```

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æ”¹è¿› |
|------|-------|-------|------|
| 10,000 è¡ŒåŠ è½½æ—¶é—´ | ~5 ç§’ | ~0.5 ç§’ | **90%** |
| å†…å­˜å ç”¨ï¼ˆ10,000 è¡Œï¼‰ | ~500 MB | ~50 MB | **90%** |
| æ»šåŠ¨æµç•…åº¦ | å¡é¡¿ | ä¸æ»‘ | - |
| æ”¯æŒæœ€å¤§è¡Œæ•° | ~10,000 | **æ— é™åˆ¶** | - |

## ğŸ” è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. åŠ¨æ€è¡Œé«˜

å¦‚æœæ¯è¡Œé«˜åº¦ä¸å›ºå®šï¼Œéœ€è¦ï¼š

```typescript
// æ–¹æ¡ˆ 1: ä½¿ç”¨å¹³å‡é«˜åº¦ä¼°ç®—
const avgHeight = totalHeight / totalCount

// æ–¹æ¡ˆ 2: è®°å½•æ¯è¡Œå®é™…é«˜åº¦ï¼ˆå¤æ‚ï¼‰
const heightCache = new Map<number, number>()
```

### 2. æœç´¢é«˜äº®

```typescript
// è™šæ‹Ÿæ»šåŠ¨ + æœç´¢
function handleSearch(keyword) {
  // 1. è¿‡æ»¤æ•°æ®
  const filtered = allLines.filter(line =>
    line.content.includes(keyword)
  )

  // 2. æ›´æ–°è™šæ‹Ÿæ»šåŠ¨çš„æ€»æ•°
  manager.setTotalCount(filtered.length)

  // 3. æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…
  manager.scrollToIndex(0)
}
```

### 3. çª—å£å¤§å°å˜åŒ–

```typescript
// ç›‘å¬çª—å£å˜åŒ–ï¼Œé‡æ–°è®¡ç®—è§†çª—é«˜åº¦
window.addEventListener('resize', () => {
  const newViewportHeight = calculateViewportHeight(
    container.clientHeight,
    itemHeight
  )
  manager.setViewportHeight(newViewportHeight)
})
```

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

```typescript
// ç›‘æ§æ¸²æŸ“æ€§èƒ½
import { memoryDiagnostics } from './memoryDiagnostics'

// æ»šåŠ¨å‰
const before = memoryDiagnostics.takeSnapshot('æ»šåŠ¨å‰')

// æ»šåŠ¨åˆ° 5000 è¡Œ
manager.scrollToIndex(5000)

// æ»šåŠ¨å
const after = memoryDiagnostics.takeSnapshot('æ»šåŠ¨å')

// å¯¹æ¯”å†…å­˜
memoryDiagnostics.compareSnapshots(before, after)
// é¢„æœŸï¼šå†…å­˜å˜åŒ– < 10 MB
```

## ğŸ“ æ€»ç»“

### ä¼˜åŠ¿

âœ… **æä½å†…å­˜å ç”¨** - åªæ¸²æŸ“ 30-50 ä¸ª DOM èŠ‚ç‚¹
âœ… **æ— é™æ•°æ®æ”¯æŒ** - å¯å¤„ç†ç™¾ä¸‡çº§æ•°æ®
âœ… **ä¸æ»‘æ»šåŠ¨** - 60 FPS æµç•…ä½“éªŒ
âœ… **Tail -f æ”¯æŒ** - å®æ—¶æ—¥å¿—ç›‘æ§
âœ… **å“åº”å¼è®¾è®¡** - è‡ªåŠ¨é€‚é…çª—å£å¤§å°

### é€‚ç”¨åœºæ™¯

- å¤§æ–‡ä»¶ JSONL æŸ¥çœ‹å™¨ï¼ˆâœ… å½“å‰é¡¹ç›®ï¼‰
- æ—¥å¿—å®æ—¶ç›‘æ§ï¼ˆTail -fï¼‰
- è¡¨æ ¼è™šæ‹Ÿæ»šåŠ¨
- èŠå¤©æ¶ˆæ¯åˆ—è¡¨
- ä»»ä½•éœ€è¦æ¸²æŸ“å¤§é‡åˆ—è¡¨æ•°æ®çš„åœºæ™¯

### ä¸‹ä¸€æ­¥

1. é›†æˆåˆ° JSONL Viewer
2. æ€§èƒ½æµ‹è¯•ï¼ˆ100,000 è¡Œæ•°æ®ï¼‰
3. è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆåŠ¨æ€è¡Œé«˜ã€å¿«é€Ÿæ»šåŠ¨ï¼‰
4. ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆæ»šåŠ¨å¹³æ»‘åº¦ã€åŠ è½½æŒ‡ç¤ºå™¨ï¼‰
